{% extends 'core/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Nuestros Servicios - MejíaEventos{% endblock title %}

{% block content %}
    <div class="row">
        <div class="col-12 text-center mb-5">
            <h1 class="fw-bold">Nuestros Packs y Servicios</h1>
            <p class="lead text-muted">Elige un pack base o explora nuestras soluciones individuales para tu evento.</p>
        </div>
    </div>
    
    <h2 class="fw-bold mb-4">Packs Prediseñados</h2>
    <div class="row g-4 justify-content-center">
        {% for pack in packs %}
            <div class="col-md-6 col-lg-4 d-flex align-items-stretch">
                <div class="card h-100 servicio-card">
                    <div id="carousel-{{ pack.id }}" class="carousel slide" data-bs-ride="carousel" data-bs-interval="3000">
                        <div class="carousel-inner">
                            {% for media in pack.media_gallery.all %}
                            <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                {% if media.media_type == 'VIDEO' %}
                                    <video class="d-block w-100 card-img-top" loop muted playsinline>
                                        <source src="{{ media.media_file.url }}" type="video/mp4">
                                    </video>
                                {% else %}
                                    <img src="{{ media.media_file.url }}" class="d-block w-100 card-img-top" alt="{{ pack.nombre }}">
                                {% endif %}
                            </div>
                            {% empty %}
                                <div class="carousel-item active">
                                    <img src="{{ pack.get_thumbnail_url }}" class="card-img-top" alt="{{ pack.nombre }}">
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title fw-bold">{{ pack.nombre }}</h5>
                        <p class="card-text flex-grow-1">{{ pack.descripcion|truncatewords:25 }}</p>
                        <div class="precio-container mt-auto pt-2">
                            {# Añadir descripción de oferta para Packs si aplica #}
                            {% if pack.oferta and pack.oferta.activa %}
                                <h5 class="card-text text-muted fw-normal">Antes: <del>${{ pack.precio|intcomma }}</del></h5>
                                <h4 class="card-text text-danger fw-bold">¡Oferta! ${{ pack.oferta.precio_oferta|intcomma }} CLP</h4>
                                {% if pack.oferta.descripcion_oferta %}
                                    <p class="text-success small fw-bold mb-0">{{ pack.oferta.descripcion_oferta }}</p>
                                {% endif %}
                            {% else %}
                                <h4 class="card-text text-danger fw-bold">$ {{ pack.precio|intcomma }} CLP</h4>
                            {% endif %}
                        </div>
                        <a href="{% url 'core:servicio_detail' pk=pack.id %}" class="btn btn-danger mt-auto">
                            Ver Detalles
                        </a>
                    </div>
                </div>
            </div>
        {% empty %}
            <div class="col-12"><p class="text-center text-muted">No hay packs disponibles en este momento.</p></div>
        {% endfor %}
    </div>

    <hr class="my-5">

    <h2 class="fw-bold mb-4">Servicios y Atracciones Principales</h2>
    <div class="row g-4 justify-content-center">
        {% for servicio in servicios_independientes %}
            <div class="col-md-6 col-lg-4 d-flex align-items-stretch">
                <div class="card h-100 servicio-card">
                    <div id="carousel-{{ servicio.id }}" class="carousel slide" data-bs-ride="carousel" data-bs-interval="3500">
                        <div class="carousel-inner">
                            {% for media in servicio.media_gallery.all %}
                            <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                {% if media.media_type == 'VIDEO' %}
                                    <video class="d-block w-100 card-img-top" loop muted playsinline>
                                        <source src="{{ media.media_file.url }}" type="video/mp4">
                                    </video>
                                {% else %}
                                    <img src="{{ media.media_file.url }}" class="d-block w-100 card-img-top" alt="{{ servicio.nombre }}">
                                {% endif %}
                            </div>
                            {% empty %}
                                <div class="carousel-item active">
                                    <img src="{{ servicio.get_thumbnail_url }}" class="card-img-top" alt="{{ servicio.nombre }}">
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title fw-bold">{{ servicio.nombre }}</h5>
                        <p class="card-text flex-grow-1">{{ servicio.descripcion|truncatewords:25 }}</p>
                        
                        <div class="precio-container mt-auto pt-2">
                            {% if servicio.oferta and servicio.oferta.activa %}
                                <h5 class="card-text text-muted fw-normal">Antes: <del>${{ servicio.precio|intcomma }}</del></h5>
                                <h4 class="card-text text-danger fw-bold">¡Oferta! ${{ servicio.oferta.precio_oferta|intcomma }} CLP</h4>
                                {% if servicio.oferta.descripcion_oferta %}
                                    <p class="text-success small fw-bold mb-0">{{ servicio.oferta.descripcion_oferta }}</p>
                                {% endif %}
                            {% elif servicio.has_tiered_pricing and servicio.price_tiers.all %}
                                <ul class="list-unstyled text-start mb-0">
                                    {% for tier in servicio.price_tiers.all %}
                                        <li>{{ tier.description }}: <strong class="text-danger">${{ tier.price|intcomma }}</strong></li>
                                    {% endfor %}
                                </ul>
                            {% elif servicio.precio > 0 %}
                                <h4 class="card-text text-danger fw-bold">$ {{ servicio.precio|intcomma }} CLP</h4>
                            {% else %}
                                <p class="card-text text-muted fw-bold">Precio a consultar</p>
                            {% endif %}
                        </div>

                        <a href="{% url 'core:servicio_detail' pk=servicio.id %}" class="btn btn-outline-danger mt-auto">
                            Ver Detalles
                        </a>
                    </div>
                </div>
            </div>
        {% empty %}
            <div class="col-12"><p class="text-center text-muted">No hay otros servicios disponibles en este momento.</p></div>
        {% endfor %}
    </div>

    <div class="text-center mt-5">
        <hr>
        <p class="mt-4">¿No encontraste lo que buscabas o tienes una idea diferente?</p>
        <a href="{% url 'core:solicitar_cotizacion_general' %}" class="btn btn-secondary">Envíanos una Cotización General</a>
    </div>

{% endblock content %}